# Run lint-staged for formatting
npx lint-staged

# Get changed source files (exclude config, coverage, node_modules)
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^(src|tests)/.*\.(ts|js)$' | grep -v 'coverage/' | grep -v 'node_modules/' | tr '\n' ' ')

# Run tests only if there are changed source/test files
if [ -n "$CHANGED_FILES" ]; then
  npm run jest -- --bail --findRelatedTests $CHANGED_FILES
  
  # Check if tests passed
  if [ $? -ne 0 ]; then
    echo "❌ Tests failed. Please fix the issues before committing."
    exit 1
  fi
  
  echo "✅ Tests passed!"
else
  echo "✅ No source/test files changed."
fi
